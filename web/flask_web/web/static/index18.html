<!DOCTYPE html>
<html>

<head>
    <title>jQuery DataTables Plugin | YogiHosting Demo</title>
    <meta charset="utf-8" />

    <script src="/js/jquery.min.js"></script>
     
         
           
    <link rel="stylesheet" type="text/css" href="/css/tabs.css" />
           
    <link rel="stylesheet" type="text/css" href="/css/tabstyles.css" />


    <script src="/js/MyUtility.js"></script>
    <script src="/js/jquery.dataTables.min.js"></script>
    <link href="/css/jquery.dataTables.min.css" rel="stylesheet">
    </script>
    <style>

        .dataTables_length{display: none;}
      .dataTables_filter{display: none;}
      .dataTables_paginate {display: none;}
      .dataTables_info {display: none;}

      #loading {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 10000;
  width: 100vw;
  height: 100vh;
  background-color: rgba(192, 192, 192, 0.5);
  background-image: url("/images/MnyxU.gif");
  background-repeat: no-repeat;
  background-position: center;
}

      </style>
    <script type="text/javascript" src="/js/mxClient.min.js"></script>

    <style>
        P {
            padding: 0;
        }

        body {
            background: #e7ecea;
            color: #74777b;
            font-weight: 400;
            font-size: 1em;
            font-family: 'Raleway', Arial, sans-serif;
        }

        .dataTables_length {
            display: none;
        }

        .dataTables_filter {
            display: none;
        }

        .dataTables_paginate {
            display: none;
        }

        .dataTables_info {
            display: none;
        }
        .container{
            width: 100%;
            
        }

        #content {
            width: 30%;
            float: left;
            display: block; 
        }

        #history {
            width: 70%;
            float: left;
            display: block;
        }

        .hidden {
            display: none;
        }
        .tabs-style-shape {
     max-width: 2000px;  
}
.content-wrap section {
    display: none;
    /* margin: 0 auto; */
    /* */ padding: 5px;
    max-width: 1200px;
    text-align: center;
}
    </style>
</head>

<body>
    <div id="loading"></div>
    <svg class="hidden">
        <defs>
            <path id="tabshape" d="M80,60C34,53.5,64.417,0,0,0v60H80z" />
        </defs>
    </svg>
    <div class="container">
        <div id="content" style="height:900px;">

            <table style="width:100%;">
                <tr>
                    <Td>
                        aaid
                        <input type="text" id="AliasID" value="20220422123515945336" /> <button onclick="queryAddress()">Query</button>
                    </Td>

                    <Td>
                        eid
                        <input type="text" id="EntityID" value="" /> <button onclick="queryEntity()">Query
                        </button>
                    </Td>
                </tr>

            </table>
            <div style="width: 100%; height:400px; overflow:scroll; ">
                <div id="tableCurrentHeader"> Resource</div>
                <table id="tableCurrent">

                    <thead>

                        <tr>




                        </tr>

                    </thead>

                </table>
            </div>
            <div style="width: 100%; height:400px; overflow:scroll; ">
                <div style="width:100%;">
                    <div id="tableViewHeader" style="float:left; width: 90%"> Resource</div>
                    <div id="tableViewHeader" style="float:right;width: 10%">
                        <input type="checkbox" id="allCB" checked onclick="selectAll()" />All <br>
                        <input type="checkbox" id="allROOT" />RT</div>
                </div>
                <table id="tableView">

                    <thead>

                        <tr>




                        </tr>

                    </thead>

                </table>
            </div>

        </div>
        <div id="history">
            <div class="tabs tabs-style-shape" style="width:100%;">
                <nav>
                    <ul>
                        <li>
                            <a href="#section-shape-2">
                                <svg viewBox="0 0 80 60" preserveAspectRatio="none">
                                    <use xlink:href="#tabshape"></use>
                                </svg>
                                <span>Graph</span>
                            </a>
                        </li>
                        <li>
                            <a href="#section-shape-1">
                                <svg viewBox="0 0 80 60" preserveAspectRatio="none">
                                    <use xlink:href="#tabshape"></use>
                                </svg>
                                <svg viewBox="0 0 80 60" preserveAspectRatio="none">
                                    <use xlink:href="#tabshape"></use>
                                </svg>
                                <span>History</span>
                            </a>
                        </li>

                        <li>
                            <a href="#section-shape-3">
                                <svg viewBox="0 0 80 60" preserveAspectRatio="none">
                                    <use xlink:href="#tabshape"></use>
                                </svg>
                                <svg viewBox="0 0 80 60" preserveAspectRatio="none">
                                    <use xlink:href="#tabshape"></use>
                                </svg>
                                <span>SQL</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="content-wrap">
                    <section id="section-shape-2">
                        <input type="checkbox" id="autoLayout" checked /> Auto Layout
                        <p>
                            <div id="graphContainer" style="position:absolute;overflow:auto;top:36px;bottom:0px;left:0px;right:0px;border-top:gray 1px solid;">
                            </div>
                        </p>
                    </section>
                    <section id="section-shape-1">
                        <p>
                            <table id="tableHistory">
                                <thead>
                                    <tr>
                                        <th>DN</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                            </table>
                        </p>
                    </section>
                    <section id="section-shape-3">
                        <div style=" height: 760px">
                            <div style="width: 49%; float:left; display: block; height: 100%; overflow: auto">
                                <table id="tableSQL" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th>id</th>
                                            <th>DN</th>
                                            <th>Type</th>
                                            <th>Alias</th>
                                        </tr>
                                    </thead>
                                </table>

                            </div>
                            <div style="width: 49%; float:left; display: block; height: 100% ;padding:5px">

                                <button onclick=" crateSQLs()">SQL </button>
                                <button onclick=" crateSQLsTest()">SQL Test</button>
                                <textarea id="tbSQL" style="width:100%; height: 600px">


                            </textarea>

                            </div>
                        </div>
                    </section>
                    <!--

                    <section id="section-shape-3">
                        <p>
                            <div id="graphContainer" style="position:absolute;overflow:auto;top:36px;bottom:0px;left:0px;right:0px;border-top:gray 1px solid;">
                            </div>
                        </p>
                    </section>
                   
                    <section id="section-shape-3">
                        <p>
                            <div id="SQLContainer" style="position:absolute;overflow:auto;top:36px;bottom:0px;left:0px;right:0px;border-top:gray 1px solid; height:900px;">
                              
                            </div>
                        </p>
                    </section>
-->
                </div><!-- /content -->
            </div><!-- /tabs -->

        </div>
    </div>

    <!--Reference to jQuery-->

    <script>

        var gEntityType = {
            "177": { "alias": "ESA", "prefix": "ESA", "description": "Exchange Service Area" },
            "97": { "alias": "GPS", "prefix": "GPS", "description": "GPS Location" },
            "91": { "alias": "SLOC", "prefix": "SLOC", "description": "Simple Location" },
            "89": { "alias": "ESP", "prefix": "ESP", "description": "Urban Property Address" },
            "81": { "alias": "VPI", "prefix": "VPI", "description": "VPI" },
            "68": { "alias": "ETNI", "prefix": "ETNI", "description": "Ethernet Interface" },
            "72": { "alias": "CVL", "prefix": "CVL", "description": "CVLAN" },
            "74": { "alias": "CTP", "prefix": "CTP", "description": "Connection Termination Point" },
            "79": { "alias": "ATMI", "prefix": "ATMI", "description": "ATM Interface" },
            "66": { "alias": "LDV", "prefix": "LDV", "description": "Logical Device" },
            "83": { "alias": "VCI", "prefix": "VCI", "description": "VCI" },
            "76": { "alias": "TTP", "prefix": "TTP", "description": "Trail Termination Point" },
            "70": { "alias": "SVL", "prefix": "SVL", "description": "SVLAN" },
            "87": { "alias": "SW", "prefix": "SW", "description": "Software" },
            "85": { "alias": "OS", "prefix": "OS", "description": "Operating System" },
            "9": { "alias": "AP", "prefix": "ME", "description": "Access Point" },
            "60": { "alias": "PS", "prefix": "PS", "description": "Battery" },
            "54": { "alias": "CBL", "prefix": "CBL", "description": "Cable" },
            "212741": { "alias": "DBC", "prefix": "DBC", "description": "" },
            "19": { "alias": "DF", "prefix": "DF", "description": "Distribution Field" },
            "7": { "alias": "FDF", "prefix": "ME", "description": "Fibre Distribution Frame" },
            "5": { "alias": "FDH", "prefix": "ME", "description": "Fibre Distribution Hub" },
            "27": { "alias": "FMS", "prefix": "ME", "description": "FMS" },
            "64": { "alias": "G", "prefix": "ME", "description": "Gateway" },
            "50": { "alias": "LG", "prefix": "LG", "description": "Leg" },
            "1015": { "alias": "MUD", "prefix": "ME", "description": "Multi Use Device" },
            "32": { "alias": "NC", "prefix": "NC", "description": "Network Card" },
            "3": { "alias": "OLT", "prefix": "ME", "description": "Optical Line Terminal" },
            "1": { "alias": "ONT", "prefix": "ME", "description": "Optical Node Terminal" },
            "1010": { "alias": "PPL", "prefix": "ME", "description": "Patch Panel" },
            "56": { "alias": "PL", "prefix": "PL", "description": "Physical Link" },
            "41": { "alias": "PP", "prefix": "PP", "description": "Physical Port" },
            "11": { "alias": "RK", "prefix": "RK", "description": "Rack" },
            "167": { "alias": "RMS", "prefix": "ME", "description": "Rack Mount Splitter" },
            "15": { "alias": "SF", "prefix": "SF", "description": "Shelf" },
            "25": { "alias": "SL", "prefix": "SL", "description": "Slot" },
            "23": { "alias": "SE", "prefix": "ME", "description": "Splice Enclosure" },
            "52": { "alias": "SPNT", "prefix": "SPNT", "description": "Splice Point" },
            "38": { "alias": "SP", "prefix": "SP", "description": "Splitter" },
            "212740": { "alias": "SE", "prefix": "ME", "description": "Splitter Enclosure" },
            "62": { "alias": "STB", "prefix": "ME", "description": "Set Top Box" },
            "46": { "alias": "TP", "prefix": "TP", "description": "Terminal Port" },
            "58": { "alias": "UPS", "prefix": "UPS", "description": "UPS" }
        }
        var gNodes = {};
        var gEdge = {};
        var gCurrentViewUrl = "";
        var gtable = {};
        var gSQLDT = {};
        var gHistoryData = {};
        var gHistoryDataList = [];
        var gHistoryDataListURL = {};
        var gHistoryCounter = 0;
        var gHistoryDT = {}
        var gCounter = 0;
        function cleanData(d) {
            d = d + "";
            d = d.replaceAll("null", "");
            return d;
        }
        var QUERY_API = '/n2querye?';
        function queryAddress() {
            var aid = $("#AliasID").val();
            queryData("tableView", "/nqueryp?aid=" + aid);
            $("#autoLayout").prop("checked", true);
        }
        function queryEntity() {
            var aid = $("#EntityID").val();
            queryData("tableView", QUERY_API + "eid=" + aid);
        }
        function queryData(tableID, url) {
            //  console.log(tableID, url);
       
            $("#allCB").prop("checked", true);

            if (tableID == "tableView") {
                gCurrentViewUrl = url;
            }
            if (gHistoryData.hasOwnProperty(url)) {
                // console.log("found it: ", gHistoryData[url])
                gtable[tableID].clear();

                gtable[tableID].rows.add(gHistoryData[url]).draw();

                showEntityInfo(tableID, gHistoryData[url]);

                var data = gHistoryData[url];

                if (tableID == "tableCurrent") {
                    addNodes(gHistoryData[url], data.my_id);
                }

                showHistory(tableID, data, url);
                return;
            }
            setVisible('#loading', true);
            var rt = 0;
            if ($('#allROOT').is(":checked")) {
                rt = 1
                // it is checked
            }
            url = url + "&rt=" + rt;

            $.ajax({
                url: url, success: function (result) {
                    // $("#template_tab").tmpl({ Table: result.message }).appendTo("#context");
                    //   console.log(result);
                    try {
                        result = result.replaceAll(":null", ":\"null\"");
                        result = JSON.parse(result);
                        console.log(result);
                        for (var i = 0; i < result['message'].length; i++) {
                            if (result['message'][i]["MY_ID"] == undefined) {
                                result['message'][i]["MY_ID"] = result['my_id'];

                            }
                            if (gEntityType[result['message'][i]["FROM_ETID"]] != undefined) {
                                result['message'][i]["FROM_ENKEY"] = gEntityType[result['message'][i]["FROM_ETID"]].alias;
                            }
                            if (gEntityType[result['message'][i]["TO_ETID"]] != undefined) {
                                result['message'][i]["TO_ENKEY"] = gEntityType[result['message'][i]["TO_ETID"]].alias;
                            }
                            if (result['message'][i]["A_ID"] == 0) {
                                result['message'][i]["A_ID"] = "ROOT";
                            }
                            if (result['message'][i]["MY_ID"] == result['message'][i]["FROM_UNIQUEID"]) {

                                result['message'][i]["FROM_TO"] = "TO";
                                result['message'][i]["DN"] = result['message'][i]["TO_DN"]
                                result['message'][i]["ENKEY"] = result['message'][i]["TO_ENKEY"]
                                result['message'][i]["ETYPE"] = result['message'][i]["TO_ETYPE"]
                                result['message'][i]["UNIQUEID"] = result['message'][i]["TO_UNIQUEID"]
                            } else {

                                result['message'][i]["FROM_TO"] = "FROM";
                                result['message'][i]["DN"] = result['message'][i]["FROM_DN"]
                                result['message'][i]["ENKEY"] = result['message'][i]["FROM_ENKEY"]
                                result['message'][i]["ETYPE"] = result['message'][i]["FROM_ETYPE"]
                                result['message'][i]["UNIQUEID"] = result['message'][i]["FROM_UNIQUEID"]
                            }

                        }
                        // console.log(result);

                        url = url.replaceAll("&rt=1","")
url = url.replaceAll("&rt=0","")
                        gtable[tableID].clear();
                        gtable[tableID].rows.add(result['message']).draw();

                        showEntityInfo(tableID, result['message']);
                        result['message'].index = gHistoryCounter;
                        gHistoryData[url] = result['message'];
                        if (result['my_id'] == undefined) {

                            gHistoryData[QUERY_API + "eid=" + result['message'][0]["TO_UNIQUEID"]] = result['message'];
                            result.my_id = result['message'][0]["TO_UNIQUEID"];

                        }
                        gHistoryData[url].my_id = result.my_id
                        if (tableID == "tableCurrent") {
                            addNodes(gHistoryData[url], result.my_id);
                        }
                        var data = result['message'];

                        showHistory(tableID, data, url);


                    } catch (e) {
                        console.log(e);
                    }
                    //crateSQLs();
                    setVisible('#loading', false);
                    return;

                }
            });

            //  table[tableID].ajax.url(url).load();
        }

        function showHistory(tableID, data, url) {
            if (gHistoryDataListURL[url] != undefined)
                return;
            if (tableID == "tableCurrent") {
                //console.log(result['message']);
                gHistoryDataListURL[url] = url;
                var cData = {};
                cData.url = url;
                if (data[0]["MY_ID"] == data[0]["FROM_UNIQUEID"]) {
                    cData.index = gHistoryCounter;
                    cData.dn = data[0]["FROM_DN"];

                    cData.type = data[0]["FROM_ETYPE"];
                    cData.message = gHistoryData[url]

                } else {
                    cData.index = gHistoryCounter;
                    cData.dn = data[0]["TO_DN"];

                    cData.type = data[0]["TO_ETYPE"];
                    cData.message = gHistoryData[url]
                }

                gHistoryDataList[gHistoryCounter] = cData
                gHistoryCounter++;
                gHistoryDT.clear();
                gHistoryDT.rows.add(gHistoryDataList).draw();

                // addNodes(gHistoryDataList[gHistoryCounter - 1]);
            }
        }
        function showEntityInfo(tableID, data) {
            var t = "";
            var dn = "";
            var type = "";
            var id = "";
            var cmd = "Go";


            if (data[0]["MY_ID"] == data[0]["FROM_UNIQUEID"]) {
                dn = data[0]["FROM_DN"];
                type = data[0]["FROM_ETYPE"];
                id = data[0]["MY_ID"];
            } else {

                dn = data[0]["TO_DN"];
                type = data[0]["TO_ETYPE"];
                id = data[0]["MY_ID"];
            }
            var prefix = {}

            var h = '<input type="checkbox" id="#ID#" checked class="selectME" onclick="selectByClass(\'#ID#\',\'#ID#\')" />#ID#/#AMOUNT#'
            var buttons = ""
            for (var i = 0; i < data.length; i++) {
                if (prefix[data[i]["ENKEY"]] == undefined) {
                    prefix[data[i]["ENKEY"]] = 1;
                } else {

                    prefix[data[i]["ENKEY"]] = prefix[data[i]["ENKEY"]] + 1;
                }

            }

            var keysSorted = Object.keys(prefix);
            keysSorted.forEach(element => {
                var AMOUNT = prefix[element];
                buttons = buttons + "&nbsp;" + h.replaceAll("#ID#", element).replaceAll("#AMOUNT#", AMOUNT);
            });

            //  selectAll(id, prefix) 
            //console.log(buttons);
            crateEntityInfor(dn, type, id, tableID, cmd, buttons);

            /* if (tableID == "tableCurrent") {
                 $("#" + tableID + "Header").text(t);
             } else {
                 $("#" + tableID + "Header").html(t + "&nbsp;&nbsp;<a href='javascript:queryData(getGoTableID(\"" + tableID + "\"), \QUERY_API +"eid=" + data[0]["MY_ID"] + "\")'>GO</a>");
 
             }*/

        }

        function crateEntityInfor(dn, type, id, tableID, cmd, buttons = "") {

            var t = "";
            t = dn + "(" + type + "&nbsp;" + id + ")"

            if (tableID == "tableCurrent") {
                $("#" + tableID + "Header").text(t);
            } else {
                var u = QUERY_API + "eid=" + id;
                if (cmd == "View")
                    $("#" + tableID + "Header").html(t + "&nbsp;&nbsp;<a href='javascript:queryData(getGoTableID(\"tableCurrent\"), \"" + u + "\")'>View</a>");

                if (cmd == "Go")
                    $("#" + tableID + "Header").html(t + "&nbsp;&nbsp;<a href='javascript:queryData(getGoTableID(\"tableView\"), \"" + u + "\")'>GO</a>&nbsp;" + buttons);


            }
        }
        function showNodeInfo(id) {

            var dn = "";
            var type = "";
            var cmd = "View";
            var tableID = "tableView";
            var keysSorted = Object.keys(gHistoryData).sort(function (a, b) { return gHistoryData[a].index - gHistoryData[b].index })
            keysSorted.forEach(element => {
                result = gHistoryData[element];
                for (var i = 0; i < result.length; i++) {
                    var data = result[i];
                    // console.log(data);
                    if (data["FROM_UNIQUEID"] == id) {
                        dn = data["FROM_DN"];
                        type = data["FROM_ETYPE"];
                        ;
                    }
                    if (data["TO_UNIQUEID"] == id) {

                        dn = data["TO_DN"];
                        type = data["TO_ETYPE"];
                    }
                    crateEntityInfor(dn, type, id, tableID, cmd);

                    gtable["tableView"].clear();
                    gtable["tableView"].rows.add([]).draw();
                }
            });
        }
        function getGoTableID(tableID) {
            if (tableID == "tableCurrent") {
                return "tableView";
            } else
                return "tableCurrent";
        }
        function initTable(tableID, url) {
            /*AJAX Response Binding*/

            gtable[tableID] = $('#' + tableID).DataTable({
                data: [],
                paging: false,

                ordering: false,

                info: false,

                columns: [

                    {
                        className: tableID,
                        data: 'FROM_TYPE', render: function (data, type, row) {
                            var text = cleanData(row.A_ID) + '/' + cleanData(row.A_DN);
                            if (text == "/")
                                text = "";
                            else
                                text = text + "<br/>";
                            // var t =cleanData(row.R_DN) + "<br/>" + cleanData(row.RESOURCE_UNIQUEID) + "<br/>" + cleanData(row.R_NAME) + "<br/>" + cleanData(row.R_PREFIX) + "<br/>" + cleanData(row.FROM_TYPE);
                            var t = row.DN; //+ "--"+cleanData(row.R_NAME) + "--" + cleanData(row.R_PREFIX) + "--" + cleanData(row.FROM_TYPE);

                            // if(gEntityType[])

                            if (t.replaceAll("--", "").trim() == "") {
                            } else {
                                // row.myid+"/"+ 
                                if (row.FROM_TO == "FROM")
                                    text = text + "<span style='color:red;'>F</span>&nbsp;<span style='color:red;'>" + cleanData(row.ENKEY) + "</span>&nbsp;" + row.UNIQUEID + "&nbsp;" + createQueryUrl(tableID, row.UNIQUEID, row.selected, t, row.ENKEY);
                                else
                                    text = text + "<span style='color:green;'>T</span>&nbsp;<span style='color:red;'>" + cleanData(row.ENKEY) + "</span>&nbsp;" + row.UNIQUEID + "&nbsp;" + createQueryUrl(tableID, row.UNIQUEID, row.selected, t, row.ENKEY);
                                //  return "<a href='javascript:queryData(getGoTableID(\"" + tableID + "\"), \"/queryr?ft=f&prid=" + row.PHYSICALRESOURCE_UNIQUEID + "&lrid=" + row.LOGICALRESOURCE_UNIQUEID + "\")'>" + t + "</a>";
                            }
                            return text;
                        }
                    }

                ]

            });
        }
        function createQueryUrl(tableID, pid, selected, t, et) {
            var eid = "";
            // if (pid != "null")
            eid = pid;
            // if (lid != "null")
            //    eid = lid;
            var v = "";
            if (selected == undefined || selected == "1")
                v = "checked";

            if (tableID == "tableCurrent")
                return "<a href='javascript:queryData(getGoTableID(\"" + tableID + "\"), \"" + QUERY_API + "eid=" + eid + "\")'>" + t + "</a>";
            else return "<div style='float:left; width:90%;'> " + t + "</div><div style='float:right; width:10%;'>  <input type='checkbox' id='" + pid + "' onclick='selectMe(" + pid + ")' class='selectME " + et + "' " + v + " /></div>";
        }
        function selectMe(id) {
            var ds = gHistoryData[gCurrentViewUrl];

            for (var i = 0; i < ds.length; i++) {
                var d = ds[i];
                if (d["UNIQUEID"] == id) {
                    //  console.log(d);
                    if (d["selected"] == undefined || d["selected"] == "1") {
                        d["selected"] = "0"
                    } else {

                        d["selected"] = "1";
                    }
                }
            }
        }

        function selectAll(id, prefix) {
            selectByClass("allCB", "selectME")
        }
        function selectByClass(id, prefix) {

            var ds = gHistoryData[gCurrentViewUrl];
            console.log("all");
            var v = "0";
            if ($('#' + id).is(":checked")) {
                v = "1";
                // it is checked
            }
            for (var i = 0; i < ds.length; i++) {
                var d = ds[i];
                if (d["ENKEY"] == prefix || prefix == "selectME")
                    d["selected"] = v
            }
            if (v == "1")
                $("." + prefix).prop("checked", true);
            else
                $("." + prefix).prop("checked", false);
        }

        $(function () {
            initTable('tableCurrent', '/dbquery');
            initTable('tableView', '/dbquery');

            gHistoryDT = $('#tableHistory').DataTable({
                data: [],
                paging: false,

                ordering: false,

                info: false,

                columnDefs: [

                    {

                        targets: "_all",

                        className: 'dt-body-left'

                    }

                ],
                columns: [
                    // { data: 'id' },
                    {
                        data: 'dn', render: function (data, type, row) {
                            return "<a href='javascript:queryData(getGoTableID(\"tableView\"), \"" + row.url + "\")'>" + data + "</a>";
                            // return createQueryUrl("tableCurrent", row.eid, row.eid, data);
                            //  return data;
                        }
                    },
                    { data: 'type' }
                ]
            });



            gSQLDT = $('#tableSQL').DataTable({
                data: [],
                paging: false,

                ordering: false,

                info: false,

                columnDefs: [

                    {

                        targets: "_all",

                        className: 'dt-body-left'

                    }

                ],
                columns: [
                    { data: 'id' },
                    {
                        data: 'DN', render: function (data, type, row) {
                            var url = QUERY_API + "eid=" + row.UNIQUEID;
                            return "<a href='javascript:queryData( \"tableView\" , \"" + url + "\")'>" + data + "</a>";
                            // return createQueryUrl("tableCurrent", row.eid, row.eid, data);
                            //  return data;
                        }
                    },
                    { data: 'ETYPE' },
                    { data: 'ENKEY' }
                ]
            });


        });



    </script>

    <script src="/js/cbpFWTabs.js"></script>
    <script>
        var glayout = {};
        var gorganic = {};
        var ggraph = {};
        var gparent = {};
        var gStyleArray = {};
        var gSelectedNode = {};
        var gSelectedCell = {};
        (function () {

            [].slice.call(document.querySelectorAll('.tabs')).forEach(function (el) {
                var t = new CBPFWTabs(el, { start: 3 });
                t.current = 1;
                t._show();
            });
            main(document.getElementById('graphContainer'))

            setVisible('#loading', false);
        })();



        // Program starts here. Creates a sample graph in the
        // DOM node with the specified ID. This function is invoked
        // from the onLoad event handler of the document (see below). 
        function testDraw() {

            gorganic.execute(gparent);
        }
        function main(container) {



            function HouseShape() {
                mxCylinder.call(this);
            };

            function HouseShape() {
                mxCylinder.call(this);
            };
            /*
                      The next lines use an mxCylinder instance to augment the
                      prototype of the shape ("inheritance") and reset the
                      constructor to the topmost function of the c'tor chain.
            */
            mxUtils.extend(HouseShape, mxCylinder);

            // Defines the extrusion of the box as a "static class variable"
            HouseShape.prototype.extrude = 10;


            HouseShape.prototype.redrawPath = function (canvas, x, y, w, h, isForeground) {
                var dy = this.extrude * this.scale;
                var dx = this.extrude * this.scale;
                var myScale = this.scale * (w / 500)
                var myScaley = this.scale * (h / 500)
                if (isForeground) {

                    canvas.begin();

                    //canvas.translate(x, y);
                    canvas.moveTo(0, 267.945 * myScaley);
                    canvas.lineTo(73.023 * myScale, 267.945 * myScaley);
                    canvas.lineTo(73.023 * myScale, 490 * myScaley);
                    canvas.lineTo(418.416 * myScale, 490 * myScaley);
                    canvas.lineTo(418.416 * myScale, 267.945 * myScaley);
                    canvas.lineTo(491.47 * myScale, 267.945 * myScaley);
                    canvas.lineTo(245.712 * myScale, 0);
                    canvas.lineTo(0, 267.945 * myScaley);
                    canvas.fillAndStroke();
                    canvas.close();
                }
                /*			else
                            {
                        	
                canvas.moveTo(387.777* myScale, 237.321* myScale);
                canvas.lineTo(387.777* myScale, 459.376* myScale);
                canvas.lineTo(103.632* myScale, 459.376* myScale);
                canvas.lineTo(103.632* myScale, 237.321* myScale);
                canvas.lineTo(69.624* myScale, 237.321* myScale);
                canvas.lineTo(245.712* myScale, 45.308* myScale);
                canvas.lineTo(421.8* myScale, 237.321* myScale);
                canvas.lineTo(387.777* myScale, 237.321* myScale);
                canvas.close();
                canvas.fillAndStroke();
                            }*/
            };

            mxCellRenderer.registerShape('house', HouseShape);


            // Checks if browser is supported
            if (!mxClient.isBrowserSupported()) {
                // Displays an error message if the browser is
                // not supported.
                mxUtils.error('Browser is not supported!', 200, false);
            }
            else {
                // Creates the graph inside the given container
                ggraph = new mxGraph(container);

                // Adds rubberband selection
                new mxRubberband(ggraph);

                mxEvent.disableContextMenu(container);
                // Changes the default vertex style in-place
                var style = ggraph.getStylesheet().getDefaultVertexStyle();
                style[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;
                style[mxConstants.STYLE_GRADIENTCOLOR] = 'white';
                style[mxConstants.STYLE_PERIMETER_SPACING] = 6;
                style[mxConstants.STYLE_ROUNDED] = true;
                style[mxConstants.STYLE_SHADOW] = true;

                style = ggraph.getStylesheet().getDefaultEdgeStyle();
                style[mxConstants.STYLE_ROUNDED] = true;

                // Creates a layout algorithm to be used
                // with the graph
                glayout = new mxHierarchicalLayout(ggraph);
                gorganic = new mxFastOrganicLayout(ggraph);
                gorganic.forceConstant = 120;

                gparent = ggraph.getDefaultParent();
                gSelectedCell = gparent;
                //disable edge editing
                ggraph.isCellMovable = function (cell) {
                    return !cell.isEdge();
                }

                // Adds a button to execute the layout
                /* var button = document.createElement('button');
                 mxUtils.write(button, 'Hierarchical');
                 mxEvent.addListener(button, 'click', function (evt) {
                     layout.execute(gparent);
                 });
                 mxEvent.addListener(button, 'right-click', function (evt) {
                     layout.execute(gparent);
                 });*/
                ggraph.getTooltipForCell = function (cell) {

                    return 'Right- or shiftclick';

                }
                //document.body.appendChild(button);
                ggraph.popupMenuHandler.factoryMethod = function (menu, cell, evt) {

                    return createPopupMenu(ggraph, menu, cell, evt);

                };

                ggraph.addListener(mxEvent.CLICK, function (sender, evt) {

                    var cell = evt.getProperty("cell"); // cell may be null
                    if (cell != null) {
                        // SelectGraphCell(cell);
                        ggraph.setSelectionCell(cell);
                        // console.log(cell)
                        var url = QUERY_API + "eid=" + cell.node_id;
                       /* var rt = 0;
            if ($('#allROOT').is(":checked")) {
                rt = 1
                // it is checked
            }
            url = url + "&rt=" + rt;*/
                        if (gHistoryData.hasOwnProperty(url)) {
                            queryData("tableView", url);
                        } else {
                            showNodeInfo(cell.node_id);
                        }
                        //  gSelectedCell = cell;//.getDefaultParent();
                        // console.log(gSelectedCell.edges);

                        //  gorganic.execute(gSelectedCell);
                    }
                    evt.consume();
                });
                // Adds a button to execute the layout
                //var button = document.createElement('button');
                //mxUtils.write(button, 'Organic');

                //mxEvent.addListener(button, 'click', function (evt) {
                //    gorganic.execute(gparent);
                //});
                addStyle("ESP", null, "house");
                addStyle("NTWK", null, "cloud");
                //addStyle("ME", "/svg/rack.svg", null);
                // addStyle("OLT", "/svg/olt.svg", null);
                // addStyle("FDH", "/svg/Distributor.svg", null);
                //addStyle("SP", "/svg/spliter.svg", null);
                addStyle("CBL", "/svg/device-cable-power-svgrepo-com.svg", null);
                addStyle("default", "/svg/router-svgrepo-com.svg", null);


                var keysSorted = Object.keys(gEntityType)//.sort(function (a, b) { return gHistoryData[a].index - gHistoryData[b].index })
                keysSorted.forEach(element => {
                    result = gEntityType[element];
                    if (gStyleArray[result.alias] == undefined) {

                        addStyle(result.alias, "/svg/" + result.alias + ".svg", null);
                    }
                });

                // document.body.appendChild(button);
                // addNode();
                // Load cells and layouts the graph

                if (mxClient.IS_QUIRKS) {
                    document.body.style.overflow = 'hidden';
                    new mxDivResizer(container);
                }
            }
        };
        /*
         {
                   "A_DN": "null",
                   "A_ID": "null",
                   "FROM_DN": "NTWK=SNTQUTMA SNTQUTJ0005 080 To 357 W SADDLEBROOK DR 008",
                   "FROM_ENKEY": "NTWK",
                   "FROM_ETYPE": "Network",
                   "FROM_TYPE": "Network",
                   "FROM_UNIQUEID": 65099854,
                   "TO_DN": "ME=SNTQUTMA SNTQUTJ0005/RK=001/DF=001/SL=001/NC=001/PP=080",
                   "TO_ENKEY": "PP",
                   "TO_ETYPE": "Physical Port",
                   "TO_TYPE": "PhysicalResource",
                   "TO_UNIQUEID": 65085288
               },*/


        var gSQLArray = {
            "ROOT":
            {
                "table": "",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid =  <FROM_ID>.ROOTDN_ENTITYID",
                "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },
            "AiasID>Place":
            {
                "table": " from hv_address addr \r\njoin externalsystemplacesi espa on espa.externalid = addr.address_alias_id \r\njoin distinguishedname esp on esp.entityid = espa.uniqueid\r\n left join reservationsi resv on resv.PLACE_UNIQUEID = espa.UNIQUEID ",
                "table2": "  ", "columns": "addr.address_alias_id,  addr.CENTRAL_OFFICE,   addr.HOUSE_NUMBER,    addr.STREET_NAME,     addr.COMMUNITY,   addr.PROVINCE_STATE_CODE, esp.distinguishedname  esp,  resv.DISTINGUISHEDNAME resv, "
            },
            "PhysicalResource>LogicalResource":
            {
                "table": "join assoc_pr_lr a<ALIAS> on  a<ALIAS>.from_pr_id= <FROM_ID>.entityid and a<ALIAS>.associationpattern_id = <A_ID> --<A_DN>  ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid =  a<ALIAS>.to_lr_id ",
                "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },
            "Network>Network":
            {
                "table": "join NETWORKSI_VIEW a<ALIAS> on a<ALIAS>.UNIQUEID = <FROM_ID>.entityid  ",
                "table2": "  join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.FROMNETWORK_UNIQUEID ",
                "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },

            //join NETWORKSI_VIEW aNTWK1 on aNTWK1.UNIQUEID = NTWK.entityid  
            // join distinguishedname NTWK1 on NTWK1.entityid = aNTWK1.FROMNETWORK_UNIQUEID 

            //join AGGR_NET_PR aPP on aPP.NETWORKSI_UNIQUEID =NTWK.entityid
            //join distinguishedname PP on PP.entityid = aPP.NETWORKSI_UNIQUEID  
            "Network_old>PhysicalResource":
            {
                "table": "join AGGR_NET_PR a<ALIAS> on a<ALIAS>.PHYSICALRESOURCE_UNIQUEID = <FROM_ID>.entityid  ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.NETWORKSI_UNIQUEID  ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            }, "Network>PhysicalResource":
            {
                "table": "join AGGR_NET_PR a<ALIAS> on a<ALIAS>.PHYSICALRESOURCE_UNIQUEID = <FROM_ID>.entityid  ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.NETWORKSI_UNIQUEID  ", "columns": "<ALIAS>.distinguishedname <ALIAS>\r\n  "
            }, "Network>PhysicalResource>TO":
            {
                "table": "join AGGR_NET_PR a<ALIAS> on a<ALIAS>.NETWORKSI_UNIQUEID = <FROM_ID>.entityid -- and a<ALIAS>.SEQUENCE =1 \r",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.PHYSICALRESOURCE_UNIQUEID  ", "columns": "<ALIAS>.distinguishedname <ALIAS>\r\n ,a<ALIAS>.SEQUENCE <ALIAS>_SEQUENCE "
            }
           /* ,  "PhysicalResource>Network":
            {
               "table": "join AGGR_NET_PR a<ALIAS> on a<ALIAS>.PHYSICALRESOURCE_UNIQUEID = <FROM_ID>  ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.PHYSICALRESOURCE_UNIQUEID  ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            }*/,
            "PhysicalResource>PhysicalResource":
            {
                "table": "join assoc_pr_pr a<ALIAS> on a<ALIAS>.to_pr_id = <FROM_ID>.entityid and a<ALIAS>.associationpattern_id = <A_ID> --<A_DN> ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.from_pr_id ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },
            "PhysicalResource>PhysicalResource>TO":
            {
                "table": "join assoc_pr_pr a<ALIAS> on a<ALIAS>.from_pr_id = <FROM_ID>.entityid and a<ALIAS>.associationpattern_id = <A_ID> --<A_DN> ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.to_pr_id ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },
            "PhysicalResource>Place":
            {
                "table": "join assoc_pr_pl a<ALIAS> on a<ALIAS>.to_pl_id = <FROM_ID>.entityid and a<ALIAS>.associationpattern_id = <A_ID> --<A_DN> ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.from_pr_id ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },
            "PhysicalResource>Place>First":
            {
                "table": "join assoc_pr_pl a<ALIAS> on a<ALIAS>.from_pr_id = <FROM_ID>.entityid and a<ALIAS>.associationpattern_id = <A_ID> --<A_DN> ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.to_pl_id ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            },
            "PhysicalResource>Place>TO":
            {
                "table": "join assoc_pr_pl a<ALIAS> on a<ALIAS>.from_pr_id = <FROM_ID>.entityid and a<ALIAS>.associationpattern_id = <A_ID> --<A_DN> ",
                "table2": " join distinguishedname <ALIAS> on <ALIAS>.entityid = a<ALIAS>.to_pl_id ", "columns": "<ALIAS>.distinguishedname <ALIAS>"
            }
        }
        var gAliasArray = {};
        var gENKEYArray = {};//{"ESP":0};

        var gTestData = [
            {
                "A_DN": "AR=Access Point to ESP",
                "A_ID": 193,
                "FROM_DN": "ME=CPCRFL A2K5V",
                "FROM_ENKEY": "AP",
                "FROM_ETID": 9,
                "FROM_ETYPE": "Access Point",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 29093817,
                "MY_ID": 21995525,
                "TO_DN": "ESP=21315686762011021821",
                "TO_ENKEY": "ESP",
                "TO_ETID": 89,
                "TO_ETYPE": "Urban Property Address",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 21995525,
                "FROM_TO": "FROM",
                "DN": "ME=CPCRFL A2K5V",
                "ENKEY": "AP",
                "ETYPE": "Access Point",
                "UNIQUEID": 29093817
            },
            {
                "A_DN": "AR=Access Point to ESP",
                "A_ID": 193,
                "FROM_DN": "ME=CPCRFL A2K5V",
                "FROM_ENKEY": "AP",
                "FROM_ETID": 9,
                "FROM_ETYPE": "Access Point",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 29093817,
                "MY_ID": 21995525,
                "TO_DN": "ESP=21315686762011021821",
                "TO_ENKEY": "ESP",
                "TO_ETID": 89,
                "TO_ETYPE": "Urban Property Address",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 21995525,
                "FROM_TO": "FROM",
                "DN": "ME=CPCRFL A2K5V",
                "ENKEY": "AP",
                "ETYPE": "Access Point",
                "UNIQUEID": 29093817
            },
            {
                "A_DN": "AR=Access Point to ESP",
                "A_ID": 193,
                "FROM_DN": "ME=CPCRFL A2K5V",
                "FROM_ENKEY": "AP",
                "FROM_ETID": 9,
                "FROM_ETYPE": "Access Point",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 29093817,
                "TO_DN": "ESP=21315686762011021821",
                "TO_ENKEY": "ESP",
                "TO_ETID": 89,
                "TO_ETYPE": "Urban Property Address",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 21995525,
                "MY_ID": 29093817,
                "FROM_TO": "TO",
                "DN": "ESP=21315686762011021821",
                "ENKEY": "ESP",
                "ETYPE": "Urban Property Address",
                "UNIQUEID": 21995525
            },
            {
                "A_DN": "AR=Cable to Access Point",
                "A_ID": 106,
                "FROM_DN": "CBL=CPCRFLXA F203W",
                "FROM_ENKEY": "CBL",
                "FROM_ETID": 54,
                "FROM_ETYPE": "Cable",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 32750404,
                "TO_DN": "ME=CPCRFL A2K5V",
                "TO_ENKEY": "AP",
                "TO_ETID": 9,
                "TO_ETYPE": "Access Point",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 29093817,
                "MY_ID": 29093817,
                "FROM_TO": "FROM",
                "DN": "CBL=CPCRFLXA F203W",
                "ENKEY": "CBL",
                "ETYPE": "Cable",
                "UNIQUEID": 32750404
            },
            {
                "A_DN": "AR=FDH to Cable Root",
                "A_ID": 105,
                "FROM_DN": "ME=CPCRFL A0T7E",
                "FROM_ENKEY": "FDH",
                "FROM_ETID": 5,
                "FROM_ETYPE": "Fibre Distribution Hub",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 22441326,
                "TO_DN": "CBL=CPCRFLXA F203W",
                "TO_ENKEY": "CBL",
                "TO_ETID": 54,
                "TO_ETYPE": "Cable",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 32750404,
                "MY_ID": 32750404,
                "FROM_TO": "FROM",
                "DN": "ME=CPCRFL A0T7E",
                "ENKEY": "FDH",
                "ETYPE": "Fibre Distribution Hub",
                "UNIQUEID": 22441326
            },
            {
                "A_DN": "AR=FDH to Cable Root",
                "A_ID": 105,
                "FROM_DN": "ME=CPCRFL A0T7E",
                "FROM_ENKEY": "FDH",
                "FROM_ETID": 5,
                "FROM_ETYPE": "Fibre Distribution Hub",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 22441326,
                "TO_DN": "CBL=CPCRFLXA F203W",
                "TO_ENKEY": "CBL",
                "TO_ETID": 54,
                "TO_ETYPE": "Cable",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 32750404,
                "MY_ID": 22441326,
                "FROM_TO": "TO",
                "DN": "CBL=CPCRFLXA F203W",
                "ENKEY": "CBL",
                "ETYPE": "Cable",
                "UNIQUEID": 32750404
            },
            {
                "A_DN": "AR=Cable To FDH",
                "A_ID": 104,
                "FROM_DN": "CBL=CPCRFLXAOL2 FEEDER",
                "FROM_ENKEY": "CBL",
                "FROM_ETID": 54,
                "FROM_ETYPE": "Cable",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 24045341,
                "TO_DN": "ME=CPCRFL A0T7E",
                "TO_ENKEY": "FDH",
                "TO_ETID": 5,
                "TO_ETYPE": "Fibre Distribution Hub",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 22441326,
                "MY_ID": 22441326,
                "FROM_TO": "FROM",
                "DN": "CBL=CPCRFLXAOL2 FEEDER",
                "ENKEY": "CBL",
                "ETYPE": "Cable",
                "UNIQUEID": 24045341
            },
            {
                "A_DN": "AR=OLT to Cable",
                "A_ID": 166,
                "FROM_DN": "ME=CPCRFLXAOL2",
                "FROM_ENKEY": "OLT",
                "FROM_ETID": 3,
                "FROM_ETYPE": "Optical Line Terminal",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 21536320,
                "TO_DN": "CBL=CPCRFLXAOL2 FEEDER",
                "TO_ENKEY": "CBL",
                "TO_ETID": 54,
                "TO_ETYPE": "Cable",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 24045341,
                "MY_ID": 24045341,
                "FROM_TO": "FROM",
                "DN": "ME=CPCRFLXAOL2",
                "ENKEY": "OLT",
                "ETYPE": "Optical Line Terminal",
                "UNIQUEID": 21536320
            },
            {
                "A_DN": "AR=OLT to GPS",
                "A_ID": 157,
                "FROM_DN": "ME=CPCRFLXAOL2",
                "FROM_ENKEY": "OLT",
                "FROM_ETID": 3,
                "FROM_ETYPE": "Optical Line Terminal",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 21536320,
                "TO_DN": "GPS=26.5810600|-81.9660100",
                "TO_ENKEY": "GPS",
                "TO_ETID": 97,
                "TO_ETYPE": "GPS Location",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 2928110,
                "MY_ID": 21536320,
                "FROM_TO": "TO",
                "DN": "GPS=26.5810600|-81.9660100",
                "ENKEY": "GPS",
                "ETYPE": "GPS Location",
                "UNIQUEID": 2928110
            },
            {
                "A_DN": "AR=OLT Root to Logical Device",
                "A_ID": 115,
                "FROM_DN": "ME=CPCRFLXAOL2",
                "FROM_ENKEY": "OLT",
                "FROM_ETID": 3,
                "FROM_ETYPE": "Optical Line Terminal",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 21536320,
                "TO_DN": "LDV=CPCRFLXAOL2",
                "TO_ENKEY": "LDV",
                "TO_ETID": 66,
                "TO_ETYPE": "Logical Device",
                "TO_TYPE": "LogicalResource",
                "TO_UNIQUEID": 21519883,
                "MY_ID": 21519883,
                "FROM_TO": "FROM",
                "DN": "ME=CPCRFLXAOL2",
                "ENKEY": "OLT",
                "ETYPE": "Optical Line Terminal",
                "UNIQUEID": 21536320
            }
        ];
        var gTestData2 = [
            {
                "A_DN": "AR=AP Terminal Port to ESP",
                "A_ID": 502,
                "FROM_DN": "ME=NPLTFLKL 177954/TP=001",
                "FROM_ENKEY": "TP",
                "FROM_ETID": 46,
                "FROM_ETYPE": "Terminal Port",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 91495458,
                "MY_ID": 99722401,
                "TO_DN": "ESP=11421511161249312131",
                "TO_ENKEY": "ESP",
                "TO_ETID": 89,
                "TO_ETYPE": "Urban Property Address",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 99722401,
                "FROM_TO": "FROM",
                "DN": "ESP=11421511161249312131",
                "ENKEY": "ESP",
                "ETYPE": "Urban Property Address",
                "UNIQUEID": 99722401,
                "id": 0
            },
            {
                "A_DN": "AR=AP Terminal Port to ESP",
                "A_ID": 502,
                "FROM_DN": "ME=NPLTFLKL 177954/TP=001",
                "FROM_ENKEY": "TP",
                "FROM_ETID": 46,
                "FROM_ETYPE": "Terminal Port",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 91495458,
                "MY_ID": 99722401,
                "TO_DN": "ESP=11421511161249312131",
                "TO_ENKEY": "ESP",
                "TO_ETID": 89,
                "TO_ETYPE": "Urban Property Address",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 99722401,
                "FROM_TO": "FROM",
                "DN": "ME=NPLTFLKL 177954/TP=001",
                "ENKEY": "TP",
                "ETYPE": "Terminal Port",
                "UNIQUEID": 91495458
            },
            {
                "A_DN": "AR=AP Terminal Port to ONT",
                "A_ID": 111,
                "FROM_DN": "ME=NPLTFLKL 177954/TP=001",
                "FROM_ENKEY": "TP",
                "FROM_ETID": 46,
                "FROM_ETYPE": "Terminal Port",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 91495458,
                "TO_DN": "ME=1827 MUSTIQUE ST NAPLES FL",
                "TO_ENKEY": "ONT",
                "TO_ETID": 1,
                "TO_ETYPE": "Optical Node Terminal",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 99927543,
                "MY_ID": 91495458,
                "FROM_TO": "TO",
                "DN": "ME=1827 MUSTIQUE ST NAPLES FL",
                "ENKEY": "ONT",
                "ETYPE": "Optical Node Terminal",
                "UNIQUEID": 99927543
            },
            {
                "A_DN": "AR=Cable Physical Link to AP Terminal Port",
                "A_ID": 112,
                "FROM_DN": "CBL=GLGCFLXA FD701/PL=257",
                "FROM_ENKEY": "PL",
                "FROM_ETID": 56,
                "FROM_ETYPE": "Physical Link",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 91871628,
                "TO_DN": "ME=NPLTFLKL 177954/TP=001",
                "TO_ENKEY": "TP",
                "TO_ETID": 46,
                "TO_ETYPE": "Terminal Port",
                "TO_TYPE": "PhysicalResource",
                "TO_UNIQUEID": 91495458,
                "MY_ID": 91495458,
                "FROM_TO": "FROM",
                "DN": "CBL=GLGCFLXA FD701/PL=257",
                "ENKEY": "PL",
                "ETYPE": "Physical Link",
                "UNIQUEID": 91871628
            },
            {
                "A_DN": "AR=ONT Physical Port to ESP",
                "A_ID": 461,
                "FROM_DN": "ME=1827 MUSTIQUE ST NAPLES FL/SL=002/NC=001/PP=001",
                "FROM_ENKEY": "PP",
                "FROM_ETID": 41,
                "FROM_ETYPE": "Physical Port",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 99927705,
                "MY_ID": 99722401,
                "TO_DN": "ESP=11421511161249312131",
                "TO_ENKEY": "ESP",
                "TO_ETID": 89,
                "TO_ETYPE": "Urban Property Address",
                "TO_TYPE": "Place",
                "TO_UNIQUEID": 99722401,
                "FROM_TO": "FROM",
                "DN": "ME=1827 MUSTIQUE ST NAPLES FL/SL=002/NC=001/PP=001",
                "ENKEY": "PP",
                "ETYPE": "Physical Port",
                "UNIQUEID": 99927705
            },
            {
                "A_DN": "AR=ONT Physical Port to Ethernet Trail Termination Point",
                "A_ID": 122,
                "FROM_DN": "ME=1827 MUSTIQUE ST NAPLES FL/SL=002/NC=001/PP=001",
                "FROM_ENKEY": "PP",
                "FROM_ETID": 41,
                "FROM_ETYPE": "Physical Port",
                "FROM_TYPE": "PhysicalResource",
                "FROM_UNIQUEID": 99927705,
                "TO_DN": "LDV=NPLTFLKLH00/ETNI=001/SVL=2038/CVL=168/TTP=1",
                "TO_ENKEY": "TTP",
                "TO_ETID": 76,
                "TO_ETYPE": "Trail Termination Point",
                "TO_TYPE": "LogicalResource",
                "TO_UNIQUEID": 100294678,
                "MY_ID": 99927705,
                "FROM_TO": "TO",
                "DN": "LDV=NPLTFLKLH00/ETNI=001/SVL=2038/CVL=168/TTP=1",
                "ENKEY": "TTP",
                "ETYPE": "Trail Termination Point",
                "UNIQUEID": 100294678
            }
        ];

        function crateSQLsTest() {
            generateSQL(gTestData2); return;
        }
        function crateSQLs() {




            var tmpData = [];

            //   generateSQL(gTestData); return;

            var keysSorted = Object.keys(gSelectedNode).sort(function (a, b) { return gSelectedNode[a].index - gSelectedNode[b].index })
            var d = []
            // console.log(keysSorted);
            keysSorted.forEach(element => {
                var n = gSelectedNode[element]

                if (n != null) {
                    var result = gHistoryData[n.nocecode];
                    //console.log(result);
                    for (var i = 0; i < result.length; i++) {
                        var data = result[i];

                        var data2 = JSON.parse(JSON.stringify(data));
                        if (data["selected"] != "0") {

                            if (n.node_id == data["UNIQUEID"] + "") {
                                tmpData.push(data2);
                                i = result.length;
                            }
                            if (i < result.length && n.node_id == data["TO_UNIQUEID"] + "") {
                                data2.id = n.index;
                                data2.UNIQUEID = data2.TO_UNIQUEID
                                data2.DN = data2.TO_DN
                                data2.ETYPE = data2.TO_ETYPE
                                data2.ENKEY = data2.TO_ENKEY
                                tmpData.push(data2);
                                i = result.length;
                            }
                        }
                    }
                }
            });
            /*
            var keysSorted = Object.keys(gHistoryData).sort(function (a, b) { return gHistoryData[a].index - gHistoryData[b].index })
            
            var tmpData = [];
            keysSorted.forEach(element => {
                result = gHistoryData[element];
                for (var i = 0; i < result.length; i++) {
                    var data = result[i];

                    var selected = null;
                    try {
                        selected = gSelectedNode[data["UNIQUEID"]];
                    } catch (e) {

                    }
                    // selected = "";
                    if (selected != null && selected != undefined && (data["selected"] == undefined || data["selected"] == "1")) {
                         tmpData.push(data);
                        
                    }
                }
 
            });
            */

            console.log(tmpData);
            generateSQL(tmpData);
        }



        function generateSQL(da) {

            var sqlHistory = {};


            var key = "AiasID>Place"
            var sql = "";
            var sel = "select addr.address_alias_id, esp.distinguishedname  esp, \r\n";
            var aid = $("#AliasID").val();
            var where = "\r\n where addr.address_alias_id='" + aid + "'";

            var ESPFlag = true;
            sql = gSQLArray[key].table;
            sel = " select " + gSQLArray[key].columns;

            if (da.length > 0 && da[0]["ENKEY"] != "ESP") {
                var data = da[0];

                key = data["FROM_TYPE"] + ">" + data["TO_TYPE"];
                sel = "select " + data["ENKEY"] + ".distinguishedname " + data["ENKEY"] + ",\r\n";
                sql = "  from  distinguishedname   " + data["ENKEY"] + " "
                var id = data["UNIQUEID"]
                where = "\r\n where " + data["ENKEY"] + ".entityid='" + id + "'";
                ESPFlag = false;
            }

            var firstESPFlag = true;
            var flag = 0;
            var p_next_id = gSQLArray[key].next_id;

            for (var i = 1; i < da.length; i++) {
                var data = da[i];

                var selected = null;
                try {
                    selected = gSelectedNode[data["UNIQUEID"]];
                } catch (e) {

                }
                selected = "";
                if (selected != null && selected != undefined) {
                    key = data["FROM_TYPE"] + ">" + data["TO_TYPE"];
                    if (data["FROM_TO"] == "TO" && data["FROM_TYPE"] == "Network")
                        key = data["FROM_TYPE"] + ">" + data["TO_TYPE"] + ">TO";

                    if (data["FROM_TO"] == "TO" && data["TO_TYPE"] == "Place")
                        key = data["FROM_TYPE"] + ">" + data["TO_TYPE"] + ">TO";
                    if (data["FROM_TO"] == "TO" && data["TO_TYPE"] == "PhysicalResource")
                        key = data["FROM_TYPE"] + ">" + data["TO_TYPE"] + ">TO";
                    // console.log(key, data["FROM_TO"], data["FROM_TYPE"], data["TO_TYPE"]);
                    console.log(data);
                    // if (data["ENKEY"] != "ESP") {
                    if (key == "PhysicalResource>Place" && firstESPFlag && ESPFlag == false) {

                        firstESPFlag = false;
                        key = key + ">First"
                        data["FROM_TO"] = 'TO'

                    }
                    if (data["A_ID"] == "ROOT")
                        key = "ROOT"
                    console.log(key);
                    var sk = data["ENKEY"] + data["UNIQUEID"];

                    if (sqlHistory[sk] == undefined) {
                        if (flag == 1)
                            sel = sel + ", "
                        sel = sel + gSQLArray[key].columns + "\r\n";

                        sel = sel.replaceAll("\\<ALIAS\\>", getAlias(data["ENKEY"], data["UNIQUEID"]));

                        sql = sql + "\r\n" + getSQL(key, data)
                        flag = 1;

                    } else {

                        //  console.log("didn't find sk", sk, data);
                    }
                    sqlHistory[sk] = sk;

                    //  p_next_id = gSQLArray[key].next_id;
                    // }

                }
            }


            $("#tbSQL").val(sel + " " + sql + " " + where + ";");
        }

        function setVisible(selector, visible) {
            document.querySelector(selector).style.display = visible ? 'block' : 'none';
        }

        function getSQL(key, data) {
            var sql = "";
            sql = gSQLArray[key].table;
            sql = sql + "\r\n" + gSQLArray[key].table2;
            if (data == null) {
                return sql;
            } else {
                for (var k in data) {
                    //   console.log(k);
                    sql = sql.replaceAll("\\<ALIAS\\>", getAlias(data["ENKEY"], data["UNIQUEID"]));
                    if (data["FROM_TO"] == "TO" && data["FROM_TYPE"] == "Network")
                        sql = sql.replaceAll("\\<FROM_ID\\>", getAlias(data["FROM_ENKEY"], data["FROM_UNIQUEID"]));
                    else
                        if (data["FROM_TO"] == "TO")// &&( data["TO_TYPE"] == "Place" ||  data["TO_TYPE"] =="LogicalResource"))
                            sql = sql.replaceAll("\\<FROM_ID\\>", getAlias(data["FROM_ENKEY"], data["FROM_UNIQUEID"]));
                        else
                            sql = sql.replaceAll("\\<FROM_ID\\>", getAlias(data["TO_ENKEY"], data["TO_UNIQUEID"]));
                    sql = sql.replaceAll("\\<A_ID\\>", data["A_ID"]);
                    sql = sql.replaceAll("\\<A_DN\\>", data["A_DN"]);
                    //   console.log(data);
                    //  console.log(sql);
                }
            }
            return sql

        }
        function getAlias(enkey, uid) {
            var key = enkey + "_" + uid;
            var k = gAliasArray[key];
            // console.log(k);
            if (k != undefined) {
                // console.log(k);
                return k;
            }
            if (gENKEYArray[enkey] != undefined) {
                var c = gENKEYArray[enkey] + 1;
                gENKEYArray[enkey] = c;
                k = enkey + c;
            } else {
                gENKEYArray[enkey] = 0;
                k = enkey;
            }
            gAliasArray[key] = k;
            //  console.log(k);
            return k;
        }
        var gSQLCounter = 0;
        function addNodes(nodeGroup, my_id) {



            ggraph.getModel().beginUpdate();
            // console.log("addNodes:", nodeGroup);

            try {
                var message = nodeGroup;

                for (var i = 0; i < message.length; i++) {
                    var data = message[i];
                    var fromNode = gNodes[data.FROM_UNIQUEID]
                    var toNode = gNodes[data.TO_UNIQUEID]
                    if (data["selected"] == undefined || data["selected"] == "1") {

                        if (fromNode == null) {
                            fromNode = addNode({ id: data.FROM_UNIQUEID, text: data.FROM_DN, type: data.FROM_ENKEY, my_id: my_id });

                            gNodes[data.FROM_UNIQUEID] = fromNode;
                        }

                        if (toNode == null) {
                            toNode = addNode({ id: data.TO_UNIQUEID, text: data.TO_DN, type: data.TO_ENKEY, my_id: my_id });

                            gNodes[data.TO_UNIQUEID] = toNode;

                        }
                        addLink(fromNode, toNode, (data.A_ID + "").replaceAll("null", ""));

                    }
                    else {


                        var myNode = gNodes[data.UNIQUEID]
                        if (myNode != null) {
                            // fromNode = addNode({ id: data.FROM_UNIQUEID, text: data.FROM_DN, type: data.FROM_ENKEY });
                            console.log(my_id, myNode.my_id);
                            if (my_id == myNode.my_id) {
                                // gNodes[data.FROM_UNIQUEID] = fromNode;
                                ggraph.getModel().remove(myNode);
                                gNodes[data.UNIQUEID] = null;
                                deleteLink(data.UNIQUEID);

                            }
                        }
                        // addLink(fromNode, toNode, (data.A_ID + "").replaceAll("null", ""));


                    }
                }

                //  glayout.execute(gparent);

                //gorganic.execute(gparent);

                if ($('#autoLayout').is(":checked")) {

                    gorganic.execute(gSelectedCell);
                }
            }
            finally {
                // Updates the display
                ggraph.getModel().endUpdate();
            }

        }
        function deleteLink(id) {

            var keysSorted = Object.keys(gEdge);
            //console.log(keysSorted);

            var d = []
            keysSorted.forEach(element => {
                if (element.indexOf(id + ">") >= 0 || element.indexOf(">" + id) >= 0)
                    gEdge[element] = null;
            });
        }
        function addStyle2(name, svg) {

            gStyleArray[name] = svg;
        }
        function createPopupMenu(graph, menu, cell, evt) {
            if (cell != null) {
                menu.addItem('Select', '/svg/router-svgrepo-com.svg', function () {
                    console.log("MenuItem1");

                    console.log(cell.sname)
                    changeStyle(cell, "_S");
                    gSelectedNode[cell.node_id] = {
                        node_id: cell.node_id,
                        nocecode: QUERY_API + "eid=" + cell.my_id,
                        index: gSQLCounter
                    }

                    gSQLCounter++;

                    showInSQLTB();
                    //    mxUtils.alert('MenuItem1');
                });
            }
            else {
                menu.addItem('No-Cell Item', '/svg/router-svgrepo-com.svg', function () {
                    mxUtils.alert('MenuItem2');
                });
            }
            //menu.addSeparator();
            menu.addItem('Unselect', '/svg/router-svgrepo-com.svg', function () {

                console.log(cell.sname)
                changeStyle(cell, "");

                gSelectedNode[cell.node_id] = null;
                console.log("MenuItem2");
                showInSQLTB();
            });
            menu.addItem('View', '/svg/router-svgrepo-com.svg', function () {

                //  console.log(cell.sname)
                // changeStyle(cell, "");

                //gSelectedNode[cell.node_id] = null;
                //console.log("MenuItem2");


                queryData("tableView", QUERY_API + "eid=" + cell.node_id);
            }); menu.addItem('Go', '/svg/router-svgrepo-com.svg', function () {

                //  console.log(cell.sname)
                // changeStyle(cell, "");

                //gSelectedNode[cell.node_id] = null;
                //console.log("MenuItem2");


                queryData("tableCurrent", QUERY_API + "eid=" + cell.node_id);
            });
        };
        function showInSQLTB() {
            //var keysSorted = Object.keys(gHistoryData).sort(function (a, b) { return gHistoryData[a].index - gHistoryData[b].index })
            //console.log(keysSorted);


            var keysSorted = Object.keys(gSelectedNode).sort(function (a, b) { return gSelectedNode[a].index - gSelectedNode[b].index })
            var d = []
            // console.log(keysSorted);
            keysSorted.forEach(element => {
                var n = gSelectedNode[element]
                //console.log(n);
                if (n != null) {
                    var result = gHistoryData[n.nocecode];
                    console.log(result);
                    for (var i = 0; i < result.length; i++) {
                        var data = result[i];
                        console.log(n.node_id, data["UNIQUEID"]);
                        if (data["selected"] != "0") {

                            var data2 = JSON.parse(JSON.stringify(data));
                            if (n.node_id == data["UNIQUEID"] + "") {
                                data2.id = n.index;
                                d.push(data2);
                                i = result.length;
                            }
                            if (i < result.length && n.node_id == data["TO_UNIQUEID"] + "") {
                                data2.id = n.index;
                                data2.UNIQUEID = data2.TO_UNIQUEID
                                data2.DN = data2.TO_DN
                                data2.ETYPE = data2.TO_ETYPE
                                data2.ENKEY = data2.TO_ENKEY
                                d.push(data2);
                                i = result.length;
                            }

                        }
                        /*
                        var selected = null;
                        try {
                            selected = gSelectedNode[data["UNIQUEID"]];
                        } catch (e) {
    
                        }
                        if (selected != null && selected != undefined && (data["selected"] == undefined || data["selected"] == "1")) {
                            d.push(data);
    
                        }*/
                    }

                }
            });

            console.log(d);

            gSQLDT.clear();
            gSQLDT.rows.add(d).draw();

        }
        function changeStyle(cell, t) {
            ggraph.getModel().beginUpdate(); // required if you want to apply the highlight to all cells in a single transaction
            try {
                //graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, 'red', cell)
                //var s =mxUtils.getCellStyle(graph.getModel(), cell)
                //console.log( ggraph.getStylesheet());
                // var s = ggraph.getStylesheet().styles[cell.sname + t];

                //  var s =graph.getView().getState(cell).style;//.getStyle();//.replace(mxConstants.STYLE_IMAGE, new ImageIcon( GraphViewer.class.getResource("/com/mxgraph/examples/swing/images/cube_green.png")));
                //console.log(s);
                //  var s2 = mxUtils.clone(s);   s2.strokeColor ="red";
                //graph.getView().getState(cell).style.strokeColor ="red"
                //   console.log(s2);
                //mxStyleChange(mxGraphModel graph, java.lang.Object cell, java.lang.String style)  

                //graph.setCellStyles(  mxConstants.STYLE_STROKECOLOR, 'red'  ,cell  );
                // ggraph.setCellStyles(s, [cell]);
                if (t == "")
                    ggraph.setCellStyles(mxConstants.STYLE_STROKECOLOR, 'black', [cell]);
                else
                    ggraph.setCellStyles(mxConstants.STYLE_STROKECOLOR, 'red', [cell]);

            } finally {
                // Updates the display
                ggraph.getModel().endUpdate();
                ggraph.refresh();
            }


        }

        function addStyle(name, svg, shape) {
            if (shape == null)
                shape = mxConstants.SHAPE_LABEL;
            //  console.log(name, svg, shape);
            const style2 = new Object();
            style2[mxConstants.STYLE_SHAPE] = shape;

            style2[mxConstants.STYLE_STROKECOLOR] = '#000000';

            style2[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_CENTER;


            style2[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;

            style2[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_MIDDLE;
            if (svg != null) {
                style2[mxConstants.STYLE_IMAGE_VERTICAL_ALIGN] = mxConstants.ALIGN_MIDDLE;
                style2[mxConstants.STYLE_IMAGE_ALIGN] = mxConstants.ALIGN_LEFT;
                //  style2[mxConstants.STYLE_IMAGE_ALIGN] = mxConstants.ALIGN_CENTER;

                //  style2[mxConstants.STYLE_IMAGE_VERTICAL_ALIGN] = mxConstants.ALIGN_CENTER;

                style2[mxConstants.STYLE_IMAGE] = svg;

                style2[mxConstants.STYLE_IMAGE_WIDTH] = '48';

                style2[mxConstants.STYLE_IMAGE_HEIGHT] = '48';

                style2[mxConstants.STYLE_IMAGE] = svg;

                style2[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_RIGHT;


            } else {

                style2[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_BOTTOM;
            }

            gStyleArray[name] = name;
            style2[mxConstants.STYLE_SPACING_LEFT] = '5';

            style2[mxConstants.STYLE_SPACING] = '4';

            ggraph.getStylesheet().putCellStyle(name, style2); // name style
            // var s2 = mxUtils.clone(style2);
            //  s2[mxConstants.STYLE_STROKECOLOR] = 'red';
            // ggraph.getStylesheet().putCellStyle(name + "_S", s2); // name style
        }
        function addNode(data) {
            //  console.log("addNode", data)
            // Load cells and layouts the graph  
            var s = "default"
            try {
                if (gStyleArray[data.type] != undefined) {
                    s = data.type; //"<img src='"+gStyleArray[data.type]+"'/>"+data.text;

                }
                //   console.log("addNode", s, data.type)
            } catch (e) {

            }
            var t = breakText(data.text)
            var v1 = ggraph.insertVertex(gparent, null, t.t, 0, 0, t.rw, t.h, s);
            v1.sname = s;
            v1.node_id = data.id;
            v1.my_id = data.my_id;
            //console.log(v1);
            // if(toNode!=null)
            // var e1 = ggraph.insertEdge(gparent, null, '', v1, toNode); 
            // Executes the layout
            //  glayout.execute(gparent);
            v1.id = data.id;
            return v1;

        }



        function addLink(fromNode, toNode, aid) {
            var k = fromNode.id + ">" + toNode.id;
            //  console.log("addLink", k)
            if (gEdge[k] == null) {
                var e1 = ggraph.insertEdge(gparent, null, aid, fromNode, toNode);
                //   var e1 = ggraph.insertEdge(gparent, null, aid, fromNode, toNode);
                gEdge[k] = e1;
                //console.log(toNode.edges);
            }
            // Executes the layout


        }
        function breakText(t) {

            var r = {};

            var cutter = [{

                min: 0,

                max: 20,

                w: 20,

                h: 60,

                r: 1

            },

            {

                min: 20,

                max: 40,

                w: 20,

                h: 60,

                r: 2

            }

                ,

            {

                min: 40,

                max: 60,

                w: 20,

                h: 60,

                r: 3

            }



                ,

            {

                min: 60,

                max: 100,

                w: 30,

                h: 60,

                r: 3

            }

                ,

            {

                min: 100,

                max: 200,

                w: 40,

                h: 60,

                r: 5

            }

            ]

            for (var i = 0; i < cutter.length; i++) {

                var c = cutter[i];

                var l = 0;

                var rt = "";

                if (t.length > c.min && t.length <= c.max) {

                    l = t.length / c.r;

                    rt = "";

                    for (var i = 0; i < c.r; i++) {

                        rt = rt + t.substring(i * l, (i + 1) * l) + "\r\n"

                    }

                    c.t = rt;

                    c.rl = l
                    c.rw = c.w * 8 + 35;

                    return c;

                }

            }

        }

    </script>
</body>

</html>